# LoRaWAN EndNode Study

[TOC]

![image-20240407162525061](readme.assets/image-20240407162525061.png)

# 1. SUBGHZ

## 1.1 介绍

1. Sub-GHz是指工作频率低于1ghz12的无线网络技术。它因无线电频率低于1 ghz而得名。Sub-GHz 无线电是一种超低功耗 Sub-GHz 无线电，在 150 - 960 MHz ISM 频段运行。 

## 1.2 ST-SUBGHZ

- 模拟前端收发器，能够在其 RFO_LP 引脚上输出高达 + 15 dBm 的最大功率，在 RFO_HP 引脚上输出高达 + 22 dBm 的最大功率 .半双工 150 - 960 MHz ISM sub-GHz 无线电收发器支持.
- LoRa Rx/Tx，带宽 (BW) 为 7.8 - 500 kHz，扩频因子 (SF) 5 - 12，比特率 (BR) 为 0.013 至 17.4 Kbit/s（实际比特率） 
- Sub-GHz 无线电提供了一个内部处理单元来处理与系统 CPU 的通信。通信通过 SPI 接口发送的命令进行处理，并使用一组中断来发出事件信号。 BUSY 信息表示操作活动，并用于指示何时无法接收 sub-GHz 无线电命令

![image-20240407151530452](readme.assets/image-20240407151530452.png)

## 1.3 POWER

- VDDRF = 1.71 V 至 3.6 V VDDRF 是无线电的外部电源。它通过 VDDRF 引脚从外部提供，并且必须连接到与 VDD 相同的电源

- LDO 或 SMPS 降压转换器工作模式可通过以下方式之一进行配置： 

  - 由 MCU 使用 PWR 控制寄存器 5 (PWR_CR5) 中的 SMPSEN 设置进行配置，这取决于 MCU 系统工作模式（运行、停止、待机）或关机）。
  - 通过使用SetRegulatorMode() 命令的sub-GHz 无线电和sub-GHz 无线电操作模式（睡眠、校准、待机、使用HSE32 待机或活动）。

- 任何 POR 和 NRST 复位后，都会选择 LDO 模式。 SMPS 选择优先于 LDO 选择。

  当 sub-GHz 无线电处于 HSE32 待机或活动模式时，供电模式不会改变，直到 sub-GHz 无线电进入待机或睡眠模式。 Sub-GHz 无线电活动可能会增加进入 MCU 软件请求供电模式的延迟。LDO 或 SMPS 供电模式可通过电源状态寄存器 2 (PWR_SR2) 中的 SMPSRDY 标志进行检查

- 当无线电处于活动状态时，直到无线电活动完成后供电模式才会更改

  ![image-20240407155210772](readme.assets/image-20240407155210772.png)

## 1.4 HSE32 TXCO

- XTAL HSE32 时钟的稳定性可能会受到 sub-GHz 无线电的影响，具体取决于发射输出功率（最大 +22 dBm），从而使设备发热。加热取决于所使用的发射输出功率和设备封装。必须采用热耗散技术进行仔细的 PCB 设计，以避免热量传递到 HSE32 参考时钟源。有关与 sub-GHz 无线电相关的 HSE32 频率漂移要求，请参阅第 4.5.1 节：LoRa 调制解调器。

![image-20240407155638626](readme.assets/image-20240407155638626.png)

- 外部源(HSE32 TXCO) 在此模式下，必须提供外部TXCO 时钟源。
- 该外部源频率必须为 32 MHz。通过设置 RCC 时钟控制寄存器 (RCC_CR) 中的 HSEBYPPWR 和 HSEON 位来选择此模式。
- 占空比约为 45-55% 的外部时钟信号（正弦）
- OSC_IN 和 OSC_OUT 引脚：OSC_IN 引脚必须被驱动，而 OSC_IN 引脚必须被驱动。 OSC_OUT 引脚必须保持未连接状态。

![image-20240407160240097](readme.assets/image-20240407160240097.png)

- 当 CPU 处于低功耗模式之一（停止、待机或关机）且 subGHz 无线电处于睡眠状态时，包括 TCXO 在内的 HSE32 时钟将被禁用

![image-20240407155817464](readme.assets/image-20240407155817464.png)

- 要使用 VDDTCXO，VDDRF 电源必须至少比所选 RegTcxoTrim 电压电平高 + 200 mV。

## 1.5 发送

### 1.5.1 Transmitter high output power

- 通过 RFO_HP RF 引脚支持高达 + 22 dBm 的传输高输出功率。为此，REG PA 必须直接由 VDDSMPS 引脚上的 VDD 供电

![image-20240407152912148](readme.assets/image-20240407152912148.png)

- SMPS 的使用是可选的。当不使用 SMPS 时，可以通过移除 VLXSMPS 和 VFBSMPS 引脚之间的线圈来减少 BOM

![image-20240407161141150](readme.assets/image-20240407161141150.png)

![image-20240407152829789](readme.assets/image-20240407152829789.png)

- 输出功率范围可按约 1 dB 的 32 个步长进行编程。功率放大器斜坡时序也是可编程的。这允许适应无线电调节要求。

![image-20240407152742674](readme.assets/image-20240407152742674.png)

### 1.5.2 Transmitter low output power

- 通过 RFO_LP RF 引脚支持在整个 VDD 范围（1.8 至 3.6 V）上高达 + 15 dBm 的发射低输出功率。为此，REG PA 必须由 1.55 V 的稳压 VFBSMPS 电源供电。

![image-20240407164118853](readme.assets/image-20240407164118853.png)

## 1.6 Receiver

- 接收链包括差分低噪声放大器 (LNA)、通过正交配置中的混频器操作实现低中频的下变频器。 I 和 Q 信号经过低通滤波，并由 ƩΔ ADC 将它们转换为数字域。在数字调制解调器中，信号被抽取、进一步下变频和信道滤波。解调是根据所选的调制方案完成的。

- 下混频至低 IF 是通过将接收信号与位于负频率的本地 RF-PLL 混频来完成的，其中 -flo = -frf + -fif。 （其中 flo 是本地 RF-PLL 频率，frf 是接收信号，fif 是中频）。所需信号位于 frf = flo + fif。

- 该接收器具有自动 I 和 Q 校准功能，可改善镜像抑制。校准在使用接收器之前启动时自动完成，并且可以通过命令请求。

## 1.7 RF-PLL

- RF-PLL 用作频率合成器，用于生成发送和接收链的本地振荡器频率 (flo)。 RF-PLL 使用自动校准并使用 32 MHz HSE32 参考。 Sub-GHz 无线电覆盖 150 至 960 MHz 范围内的所有连续频率

## 1.8 Intermediate frequencies

![image-20240407165045937](readme.assets/image-20240407165045937.png)

## 1.9 LoRa 调制解调器

- LoRa 调制解调器使用扩频调制和前向纠错技术来增加 1 GHz 以下无线电通信的范围和可靠性。 LoRa 调制解调器提供改进的同信道抑制。

- LoRa 调制可以通过 Set_ModulationParams() 命令针对给定应用进行优化，从而允许在链路预算、抗干扰性、频谱占用和标称数据速率之间进行权衡。

- 可以优化以下参数：
  - 扩频因子 (SF) 
  - 调制带宽 (BW) 
  - 误码率 (CR) 
  - 低数据速率优化 (LDRO) 
- LoRa 符号率 (Rs) 定义为 Rs = BW / 2SF
- 发射的信号是恒定包络信号。等效地，每 Hz 带宽每秒发送一个码片。

### 1.9.1 扩频因子 (SF)

- LoRa扩频调制是通过用多个信息码片表示数据包有效负载的每个数据位来执行的。发送扩展信息的速率称为符号率（Rs）。标称数据速率和码片速率之间的比率是扩频因子(SF)。它表示每个数据位的符号数。

- 链路的发送端和接收端必须事先知道扩频因子。

- 接收器输入端所需的最终信噪比 (SNR) 受到扩频因子的影响。这可以提高接收器灵敏度，从而增加链路预算和范围。

- 较高的扩频因子可提供更好的接收器灵敏度、更多的链路预算和更长的范围，但代价是更长的传输时间（见下表）。

![image-20240407170539061](readme.assets/image-20240407170539061.png)

- SF它控制了chirp的速率，从而控制了数据传输的速度。每个符号可以编码SF个原始位1。例如，如果一个符号由1011111（代表十进制的95）组成，那么需要编码的原始位数就是7，因此扩频因子SF=7。

- Chips：在LoRa中，chip是最基本的信号单元。在一个给定的带宽内，chip的数量决定了数据的传输速率。chip的数量越多，数据传输速率越低，但是能够提供更好的抗干扰能力。

- `2SF (chips/symbol)`，那么就意味着一个符号包含``2^SF`个chips

### 1.9.2 带宽（BW）

- 信号带宽的增加允许使用更高的有效数据速率并减少传输时间，但代价是灵敏度降低、链路预算更少和范围更短。
- 对于允许的占用带宽存在依赖于国家/地区的监管限制。
- LoRa信号带宽是指双边带宽（DSB）。带宽选择范围如下表所示

### ![image-20240407171735277](readme.assets/image-20240407171735277.png)1.9.3 前向纠错编码率（CR）

- 通过执行前向纠错可以提高sub-GHz无线电通信的可靠性。这在存在干扰的情况下特别有效。编码率可以响应于信道条件而改变。编码率信息包含在数据包标头中以供接收器使用。

- 较高的编码率可以提供更好的抗干扰能力，但代价是传输时间更长。在正常条件下，4 / 5 的系数提供了最佳权衡。在强干扰的情况下，可以使用较高的编码率。

![image-20240407172159782](readme.assets/image-20240407172159782.png)

### 1.9.4 低数据速率优化 (LDRO)

- 对于低数据速率（通常是高 SF 或低 BW）和很长的有效负载（可能持续几秒），可以启用低数据速率优化 (LDRO)。这将每个符号的位数减少到给定的 SF 减 2，以允许接收器更好地跟踪 LoRa 接收信号。根据有效负载长度，当 LoRa 符号时间等于或高于 16.38 ms 时，通常建议采用低数据速率优化。

### 1.9.5 LoRa 帧

-  显式标头模式数据包：包括一个短标头，其中包含有关有效负载字节数、编码率和 CRC 存在的信息。
- 隐式报头模式数据包（无报头） 

![image-20240407172706123](readme.assets/image-20240407172706123.png)

- **显式标头模式** 

  默认操作模式是显式标头模式，其中标头提供有关有效负载的信息。使用最大前向纠错编码率 4/8 传输标头。它受自己的标头 CRC 保护，允许接收方在接收到无效标头时丢弃数据包。

- **隐式标头模式**

  在有效负载编码率和CRC存在是固定的或预先已知的某些操作模式中，通过调用隐式标头模式来减少传输时间可能是有利的。在此模式下，数据包帧中不存在标头。必须在 sub-GHz 无线电链路的两侧配置有效负载长度、前向纠错编码率和有效负载 CRC 的存在。